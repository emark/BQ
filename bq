#!/usr/bin/env perl
use strict;
use lib "/home/hosting_locumtest/usr/local/lib/perl5";
use Mojolicious::Lite;
use DBI;
use utf8;
use Validator::Custom;

open (DBCONF,"< db.conf") || die "Error open dbconfig file";
my @dbconf=<DBCONF>;
close DBCONF;
chomp @dbconf;
our $dbh = DBI->connect($dbconf[0],$dbconf[1],$dbconf[2],
			{ PrintError => 0, RaiseError => 1 });
$dbh->{'mysql_enable_utf8'} = 1;
$dbh->do('SET NAMES utf8');

my $vc=Validator::Custom->new;

app->secret('bqsecretphrase');

get '/' => sub {
  my $self = shift;
  $self->render('index');
};

get '/quiz'=>sub{
  my $self=shift;
  my $url=$self->param('url');
  return $self->redirect_to('/') unless $url;
  $url=~s/shop\.||www\.||store\.//g;#Drop subdomain from URL
  #if($url ne m/(\w+)\.\w+/){
    #$self->stash(message=>'Bad URL >:/');
    #return $self->render('robot');
  #}
  my $quizid=$dbh->selectrow_array("SELECT QUIZ.ID FROM QUIZ LEFT JOIN SHOP ON QUIZ.SHOPID=SHOP.ID WHERE QUIZ.STATUS=1 AND SHOP.URL='$url'") || 0;
  my $quiz=$dbh->selectall_hashref("SELECT QUIZ.ID,QUIZ.INFO,SHOP.URL AS SHOP,SHOP.DESCRIPTION FROM QUIZ LEFT JOIN SHOP ON QUIZ.SHOPID=SHOP.ID WHERE QUIZ.STATUS=1 AND SHOP.URL='$url'",'ID');
  my $question=$dbh->selectall_hashref("SELECT ROUTER.ID AS RID,QUESTION.ID AS QID,QUESTION.CONTENT,QUESTION.TYPE,QUESTION.ANSWERS FROM QUESTION INNER JOIN ROUTER ON QUESTION.ID=ROUTER.QUESTIONID LEFT JOIN QUIZ ON ROUTER.QUIZID=QUIZ.ID LEFT JOIN SHOP ON QUIZ.SHOPID=SHOP.ID WHERE QUIZ.STATUS=1 AND SHOP.URL='$url'",'RID');
  $self->session(quizid=>$quizid);
  $self->stash(quiz=>$quiz,
               question=>$question);
  $self->render('quiz');
};

post '/balance'=>sub{
  my $self=shift;
  my $email=$self->param('email');
  return $self->redirect_to('/') unless $email;
  my $balance=$dbh->selectall_hashref("SELECT BONUS.ID,BONUS.CODE, SHOP.DESCRIPTION FROM BONUS LEFT JOIN ANSWER ON BONUS.ID=ANSWER.BONUSID LEFT JOIN ROUTER ON ANSWER.ROUTERID=ROUTER.ID LEFT JOIN QUIZ ON ROUTER.QUIZID=QUIZ.ID LEFT JOIN SHOP ON QUIZ.SHOPID=SHOP.ID WHERE BONUS.EMAIL='$email' GROUP BY BONUS.CODE",'ID');
  $self->stash(balance=>$balance);
  $self->render('balance');
};

post '/robot'=>sub{
  my $self=shift;
  return $self->redirect_to('/') unless $self->session('quizid');#Defend from double refresh
  my $quizid=$self->session('quizid');
  my $param = $self->req->params->to_hash;
  my $answer='';
  my $bonusid='';
  my $sth;
  my @ref;
  my $SQL='';
  my @char=('a'..'z','A'..'Z','1'..'9');
  my $bonuscode='';
  
        # Validation Rule
        my $rule = [
            orderdate => {message => 'Input Date'} => [
                'not_blank'
            ],
            orderaddr => {message => 'Input Content'} => [
                'not_blank'
            ]
        ];
        
        # Validate
        my $vresult = $vc->validate($param, $rule);
  
  
  # Validation is OK
        if ($vresult->is_ok) {
            # Get valid data
            my $data = $vresult->data;
            
            # Save data
            # ... by yourself
        
            # Redirect
            $self->flash(success => 1);
  #Generate bonuscode
  foreach(1..8){
    $bonuscode.=$char[int(rand(60))];
  }
  $dbh->do("INSERT INTO BONUS (ID,CODE,STATUS,BCREATE,ORDERDATE,ADDRESS,EMAIL) VALUES (NULL,\"$bonuscode\",1,NOW(),\"$param->{'orderdate'}\",\"$param->{'orderaddr'}\",\"$param->{'orderemail'}\")") || die $dbh->errstr;
  $bonusid=$dbh->last_insert_id('','',"BONUS",'ID');
  $sth=$dbh->prepare("SELECT ROUTER.ID AS RID FROM ROUTER WHERE ROUTER.QUIZID=$quizid");
  $sth->execute;
  while(@ref=$sth->fetchrow_array){
    $answer=join(';',$self->param($ref[0]));
    $dbh->do("INSERT INTO ANSWER (ID,ROUTERID,BONUSID,CONTENT) VALUES (NULL,$ref[0],$bonusid,\"$answer\")") || die $dbh->errstr;
  }
  $self->session(quizid=>0);
  $self->stash(message=>$bonuscode);
  $self->redirect_to('thankyou');
  }
        
        # Validation is not OK
        else {
          $self->stash(missing => 1) if $vresult->has_missing;
          $self->flash(message => 'confirm the form') if $vresult->has_invalid;
          $self->redirect_to('/robot');
        }
  
};

get '/partners'=>sub{
  my $self=shift;
  my $list=$dbh->selectall_arrayref("SELECT SHOP.ID,SHOP.URL,SHOP.DESCRIPTION,QUIZ.INFO FROM SHOP LEFT JOIN QUIZ ON SHOP.ID=QUIZ.SHOPID ORDER BY SHOP.URL");
  $self->stash(list=>$list);
  $self->render('partners');
};

app->start;
